function toggleOldRows() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastRow = sheet.getLastRow();
  var dateColumn = 2; // Column B
  var today = new Date();
  var cutoffHide = new Date();
  cutoffHide.setDate(today.getDate() - 28); // 4 weeks

  var cutoffUnhide = new Date();
  cutoffUnhide.setFullYear(today.getFullYear() - 1); // 1 year ago

  // Read all dates at once
  var dateValues = sheet.getRange(2, dateColumn, lastRow - 1, 1).getValues(); // 2D array
  var anyHidden = false;

  // Check if any old row is hidden
  for (var i = 0; i < dateValues.length; i++) {
    var cellValue = dateValues[i][0];
    if (cellValue instanceof Date && cellValue < cutoffHide) {
      if (sheet.isRowHiddenByUser(i + 2)) { // +2 because data starts at row 2
        anyHidden = true;
        break;
      }
    }
  }

  if (anyHidden) {
    // Unhide only rows from the past year
    for (var i = 0; i < dateValues.length; i++) {
      var row = i + 2;
      var cellValue = dateValues[i][0];
      if (cellValue instanceof Date && cellValue >= cutoffUnhide) {
        sheet.showRows(row);
      }
    }
  } else {
    // Hide consecutive old rows in batches
    var start = null;
    for (var i = 0; i <= dateValues.length; i++) {
      var cellValue = i < dateValues.length ? dateValues[i][0] : null;
      var shouldHide = cellValue instanceof Date && cellValue < cutoffHide;

      if (shouldHide && start === null) {
        start = i + 2; // actual row number
      }
      if ((!shouldHide || i === dateValues.length) && start !== null) {
        sheet.hideRows(start, (i + 2) - start);
        start = null;
      }
    }
  }
}
function unhideAllRows() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastRow = sheet.getMaxRows();
  sheet.showRows(1, lastRow);
}
function hideOldRows() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastRow = sheet.getLastRow();
  var dateColumn = 2; // Column B
  var today = new Date();
  var cutoff = new Date();
  cutoff.setDate(today.getDate() - 28); // 4 weeks

  var dateValues = sheet.getRange(2, dateColumn, lastRow - 1, 1).getValues();
  var start = null;

  // Hide consecutive old rows in batches
  for (var i = 0; i <= dateValues.length; i++) {
    var cellValue = i < dateValues.length ? dateValues[i][0] : null;
    var shouldHide = cellValue instanceof Date && cellValue < cutoff;

    if (shouldHide && start === null) {
      start = i + 2; // actual row number
    }
    if ((!shouldHide || i === dateValues.length) && start !== null) {
      sheet.hideRows(start, (i + 2) - start);
      start = null;
    }
  }
}
function toggleOldAllRows() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastRow = sheet.getLastRow();
  var dateColumn = 2; // Column B
  var today = new Date();
  var cutoff = new Date();
  cutoff.setDate(today.getDate() - 28); // 4 weeks = 28 days

  // Read all dates at once
  var dateValues = sheet.getRange(2, dateColumn, lastRow - 1, 1).getValues(); // 2D array
  var anyHidden = false;

  // Check if any old row is hidden
  for (var i = 0; i < dateValues.length; i++) {
    var cellValue = dateValues[i][0];
    if (cellValue instanceof Date && cellValue < cutoff) {
      if (sheet.isRowHiddenByUser(i + 2)) { // +2 because data starts from row 2
        anyHidden = true;
        break;
      }
    }
  }

  if (anyHidden) {
    // Unhide all rows
    sheet.showRows(1, sheet.getMaxRows());
  } else {
    // Hide consecutive old rows in batches
    var start = null;
    for (var i = 0; i <= dateValues.length; i++) {
      var cellValue = i < dateValues.length ? dateValues[i][0] : null;
      var shouldHide = cellValue instanceof Date && cellValue < cutoff;

      if (shouldHide && start === null) {
        start = i + 2; // actual row number
      }
      if ((!shouldHide || i === dateValues.length) && start !== null) {
        sheet.hideRows(start, (i + 2) - start);
        start = null;
      }
    }
  }
}
